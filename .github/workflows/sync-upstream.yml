name: Sync Upstream (Daily Rebase)

# Rebase fork-patches onto the latest upstream/main daily.
# Creates a GitHub Issue if rebase conflicts need manual resolution.

on:
  schedule:
    - cron: "0 8 * * *" # daily at 8am UTC
  workflow_dispatch: # manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write # for force-push
      issues: write # for conflict notification
    steps:
      - name: Checkout fork-patches
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: fork-patches
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/openclaw/openclaw.git || true
          git fetch upstream --tags --no-recurse-submodules

      - name: Check if rebase needed
        id: check
        run: |
          BEHIND=$(git rev-list HEAD..upstream/main --count)
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT
          if [ "$BEHIND" = "0" ]; then
            echo "Already up to date with upstream/main."
          else
            echo "Behind upstream/main by $BEHIND commits."
          fi

      - name: Rebase onto upstream/main
        if: steps.check.outputs.behind != '0'
        id: rebase
        run: |
          if git rebase upstream/main; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            git rebase --abort
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Push rebased branch
        if: steps.check.outputs.behind != '0' && steps.rebase.outputs.success == 'true'
        run: git push origin fork-patches --force-with-lease

      - name: Create issue on conflict
        if: steps.check.outputs.behind != '0' && steps.rebase.outputs.success == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const behind = '${{ steps.check.outputs.behind }}';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Upstream sync conflict â€” manual rebase needed (${behind} commits behind)`,
              body: [
                `The daily rebase of \`fork-patches\` onto \`upstream/main\` failed due to conflicts.`,
                ``,
                `**Commits behind:** ${behind}`,
                ``,
                `### To resolve manually:`,
                `\`\`\`bash`,
                `cd /Users/michael/dev/midas/openclaw`,
                `git fetch upstream --tags`,
                `git checkout fork-patches`,
                `git rebase upstream/main`,
                `# resolve conflicts in each patch`,
                `git rebase --continue`,
                `git push --force-with-lease origin fork-patches`,
                `\`\`\``,
                ``,
                `After pushing, the fork-build workflow will automatically create a new release tarball.`,
              ].join('\n'),
              labels: ['sync-conflict']
            });
