name: Sync Upstream (Daily Rebase)

# Rebase fork-patches onto the latest upstream/main daily.
# On conflict, uses Claude Code CLI to attempt automated resolution.
# Creates a GitHub Issue if both the rebase and LLM resolution fail.

on:
  schedule:
    - cron: "0 8 * * *" # daily at 8am UTC
  workflow_dispatch: # manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write # for force-push
      issues: write # for conflict notification
    steps:
      - name: Checkout fork-patches
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: fork-patches
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/openclaw/openclaw.git || true
          git fetch upstream --tags --no-recurse-submodules

      - name: Check if rebase needed
        id: check
        run: |
          BEHIND=$(git rev-list HEAD..upstream/main --count)
          echo "behind=$BEHIND" >> $GITHUB_OUTPUT
          if [ "$BEHIND" = "0" ]; then
            echo "Already up to date with upstream/main."
          else
            echo "Behind upstream/main by $BEHIND commits."
          fi

      - name: Rebase onto upstream/main
        if: steps.check.outputs.behind != '0'
        id: rebase
        run: |
          if git rebase upstream/main; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            git rebase --abort
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Push rebased branch
        if: steps.check.outputs.behind != '0' && steps.rebase.outputs.success == 'true'
        run: git push origin fork-patches --force-with-lease

      # --- LLM-Assisted Conflict Resolution ---

      - name: Setup Node.js 22
        if: steps.rebase.outputs.success == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        if: steps.rebase.outputs.success == 'false'
        run: corepack enable && corepack prepare pnpm@10.23.0 --activate

      - name: Install Claude Code CLI
        if: steps.rebase.outputs.success == 'false'
        run: npm install -g @anthropic-ai/claude-code

      - name: Resolve conflicts with Claude Code
        if: steps.rebase.outputs.success == 'false'
        id: claude_resolve
        timeout-minutes: 15
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          BEHIND="${{ steps.check.outputs.behind }}"

          PROMPT=$(cat <<'PROMPT_EOF'
          You are resolving git rebase conflicts in a fork maintenance workflow.

          ## Context
          This repository is a personal fork of openclaw/openclaw. The branch
          `fork-patches` carries custom patches on top of upstream's `main`. A daily
          rebase onto `upstream/main` has produced conflicts.

          ## Step 1: Gather context
          1. Read `FORK-PATCHES.md` — it documents every active patch (what it does,
             which files, when to drop it).
          2. Run: `git log --format="%h %s%n%b" upstream/main..HEAD` to see the fork
             patch commits and their enriched messages (What/Why/How/Drop-when).

          ## Step 2: Rebase
          Run: `git rebase upstream/main`

          ## Step 3: Resolve each conflict
          For each conflict the rebase stops on:
          1. Read the conflicted files (look for <<<<<<< / ======= / >>>>>>> markers).
          2. Understand BOTH sides:
             - **Upstream (HEAD):** what the upstream change is doing
             - **Fork patch:** what the patch is trying to preserve (use the commit
               message and FORK-PATCHES.md to understand intent)
          3. Resolve by keeping BOTH upstream changes AND the fork patch's
             functionality. Adapt the fork patch code if the upstream refactored the
             area — preserve the *intent*, not necessarily the exact code.
          4. If `pnpm-lock.yaml` conflicts: accept the upstream version
             (`git checkout --theirs pnpm-lock.yaml && git add pnpm-lock.yaml`),
             then regenerate later with `pnpm install`.
          5. After resolving all files in this commit: `git add <files>` then
             `GIT_EDITOR=true git rebase --continue`
          6. If more conflicts appear in subsequent commits, repeat steps 1-5.

          ## Step 4: Verify the build
          After the rebase completes successfully:
          1. Run: `pnpm install` (regenerates lockfile if needed)
          2. Run: `pnpm build`
          If the build fails, read the error output carefully. If it's a type error
          or import issue caused by the rebase, fix it and amend the relevant commit.

          ## Rules
          - Keep ALL upstream changes — never drop upstream work
          - Preserve fork patch INTENT — adapt code to work with upstream changes
          - If you genuinely cannot resolve a conflict (e.g., upstream completely
            removed a file our patch modifies, or the semantic conflict is too
            complex), exit with a non-zero status code. Do NOT push broken code.
          - Do not create new commits — only resolve within the existing rebase flow
          PROMPT_EOF
          )

          if claude -p \
            --dangerously-skip-permissions \
            --max-turns 30 \
            --model sonnet \
            "$PROMPT" \
            > /tmp/claude-output.txt 2>&1; then
            echo "resolved=true" >> $GITHUB_OUTPUT
          else
            echo "resolved=false" >> $GITHUB_OUTPUT
          fi

          # Capture output for issue creation (truncate to 60KB for GitHub limits)
          {
            echo "claude_output<<CLAUDE_EOF"
            head -c 60000 /tmp/claude-output.txt
            echo ""
            echo "CLAUDE_EOF"
          } >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Push resolved branch
        if: steps.claude_resolve.outputs.resolved == 'true'
        run: git push origin fork-patches --force-with-lease

      - name: Create issue on unresolved conflict
        if: >
          steps.check.outputs.behind != '0' &&
          steps.rebase.outputs.success == 'false' &&
          steps.claude_resolve.outputs.resolved != 'true'
        uses: actions/github-script@v7
        env:
          CLAUDE_OUTPUT: ${{ steps.claude_resolve.outputs.claude_output }}
        with:
          script: |
            const behind = '${{ steps.check.outputs.behind }}';
            const claudeOutput = process.env.CLAUDE_OUTPUT || 'No output captured';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Upstream sync conflict — LLM resolution failed (${behind} commits behind)`,
              body: [
                `The daily rebase of \`fork-patches\` onto \`upstream/main\` failed due to conflicts.`,
                `Claude Code attempted automated resolution but was unable to resolve them.`,
                ``,
                `**Commits behind:** ${behind}`,
                ``,
                `### Claude Code output`,
                `<details>`,
                `<summary>Click to expand</summary>`,
                ``,
                '```',
                claudeOutput.slice(0, 60000),
                '```',
                `</details>`,
                ``,
                `### To resolve manually:`,
                '```bash',
                `cd /Users/michael/dev/midas/openclaw`,
                `git fetch upstream --tags`,
                `git checkout fork-patches`,
                `git rebase upstream/main`,
                `# resolve conflicts in each patch`,
                `git rebase --continue`,
                `git push --force-with-lease origin fork-patches`,
                '```',
                ``,
                `After pushing, the fork-build workflow will automatically create a new release tarball.`,
              ].join('\n'),
              labels: ['sync-conflict']
            });
